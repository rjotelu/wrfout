#!/usr/bin/env python

import os
import sys
import subprocess
import fnmatch
import re
import inspect

my_env=os.environ.copy()
my_env["NCL_LIB"] = '~/nsc/ncl-lib/'
wrf_dom = ""

wo_path = os.path.abspath(os.path.split(inspect.getfile(
    inspect.currentframe()))[0])

if wo_path not in sys.path:
    sys.path.insert(0, wo_path)

try:
    with open('run_dirs') as f:
        run_dirs = f.read().split()
except IOError as e:
    run_dirs=["."]

def set_ncl_fin(env):
    # reg= fnmatch.translate('wrfout*3')
    # print(reg)
    # reobj = re.compile(reg)
    for f in os.listdir('.'):
        if fnmatch.fnmatch(f, '*d0' + wrf_dom + '*'):
            env["NCL_FIN"] = f
            return env

def run_ncl(dir):
    global my_env
    os.chdir(dir)
    print("Entered into: " + os.path.abspath("."))
    my_env = set_ncl_fin(my_env)

    # subprocess.Popen("ncl " + wo_path + "/var_list.ncl", env=my_env, shell=True)


def main():
    for dir in run_dirs:
        return run_ncl(dir)

if __name__ == '__main__':
    main()
